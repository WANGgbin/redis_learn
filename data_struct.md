描述 redis 中的几种典型的数据结构。

# sds 简单动态字符串

说白了就是一个指针 + 长度。相比于传统的 C 字符串，优势在于：
- 字符串修改性能更好
- 二进制安全

# 链表

# 压缩列表

压缩列表的核心思想是时间换空间。在数据量较小的时候，使用链表、跳表、哈希表这样的空间结构，会造成不必要的空间浪费。我们知道，在 **redis 这种内存数据库** 中，内存是很宝贵的资源。

在数据量较小的时候，使用压缩列表，时间复杂度虽然是O(N)，但是因为数据量较小，所以性能也是可以接受的。

因此，在数据量较小的时候，可以使用压缩列表来存储数据。

# 跳表

跳表也是一种链表。普通的链表只能串行访问，跳表在一个结点中加入多个指针，每个指针属于一个单独的链表，每个链表将数据进行划分。我们可以自定向下进行类似二分查找的查找操作。

跳表相对于哈希表的优势在于：跳表最底层的数据是有序的，从而支持范围查找。

相对于红黑树的优势在于：实现更加简单。

跳表的实现：

- 某个结点的层高应该是多少呢？实际上，我们很难做到每一层对数据进行严格的均分。在创建结点的时候，**会通过一定的概率来生成结点的层高，层高越高，概率越小。** 所以跳表的平均时间复杂度是 O(logN), 而最坏事件复杂度是O(N).
- 为了方便操作链表，每个链表加入一个头结点，对应到跳表中，会单独加入一个结点，该节点的有效层高为其他所有结点的最大层高。

# 哈希表

我们都知道当哈希表的负载因子达到一定值的时候，就需要 rehash。可是怎么 rehash 呢？ 一次性完成吗？

当哈希表中存在大量的 key/val 时，如果要一次性完成 rehash，会阻塞其他请求。因此引入了 rehash 的概念。

redis 中通过引入两个哈希表来实现 rehash. 每次 增/删/改/查 的时候，就会完成一个 bucket 的 rehash。

哈希表是怎么能够应用于多个场景的呢？ 这就涉及到哈希表的多态实现。

在哈希表的定义中，有一个成员表示如何对哈希表进行操作，由一系列函数指针组成。包括：键/值 的复制，键的比较等等。

我们都知道函数指针是 c 中实现多态的经典手法。


# 整数集合

整数集合是集合键的底层实现之一，当一个集合只保存整数且数据量较小的时候，就可以考虑使用整数集合。整数集合和压缩列表的思路类似，都是时间换空间的思路。

整数集合有个比较特别的地方就是数据的升级。我们目的是为了节省空间，因此如果可以用int16_t 存储，就用 int16_t 存储，但是如果整数集合中某个数据不能使用 int16_t 存储的时候，就需要进行升级，将所有数据都升级为 int32_t 类型。

# redis 中对象跟数据结构的关系

对象跟数据结构是什么关系呢？对象是数据结构的上层，一类对象(即一类键)可以通过底层不同的数据结构来实现。

我们来看看 redis 中对象结构体的定义:

```c
typedef struct redisObject {
    // 对象的类型
    unsigned type:4;

    // 编码, 表明底层的数据结构是什么
    unsigned encoding:4;

    // 指向底层数据结构的指针
    void *ptr;
};
```
在 redis 中，我们可以通过命令 `OBJECT ENCODING KEY` 来查看 KEY 底层对应的数据结构。

接下来我们看看 redis 中不同对象可能引用的数据结构都有哪些？

- 字符串对象

  - sds
  - 整数值

    如果一个字符串对象保存的是整数值，并且这个整数值可以用 long 类型来表示，那么会将字符串对象保存在字符串对象结构的 ptr 属性里面(将 void* 转化为 long).

- 链表对象

  - 压缩列表
  - 链表

- 哈希表对象

  - 压缩列表
  - 哈希表

- 集合对象

  - 压缩列表
  - 哈希表

    哈希表的 val 是空指针。

- 有序集合对象

    redis 中的有序是通过什么排序的呢？ 通过 `score`，这个 score 是由用户指定的，是一个 double 类型的数据。
    
  - 压缩列表

    数据量较小的时候，可以考虑使用压缩列表来实现。

  - 跳表 + 哈希表

    有了跳表为什么还要使用哈希表呢？有了跳表，我们只能通过 score 来查找某个数据，如果我们向查找某个 key 对应的 score 呢？只能遍历跳表了，因此引入了哈希表。这里哈希表的 key 就是集合中的某个对象，val 是该对象对应的 score.

# redis 对象共享

redis 通过共享对象可以节省内存的耗费。每个 对象维护一个引用计数，被引用一次，引用计数加1，当引用计数为 0 的时候，则释放对象。

在 redis 启动的时候，会初始化 10000 个字符串对象，用来保存 0-9999 这 10000 个数字。

