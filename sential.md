描述 redis 的哨兵模式。

redis 的哨兵模式说白了就是 高可用的主从模式。

一般的主从模式，当主节点异常退出的时候，没有故障转移机制，导致服务不可用。而加了 sential 的哨兵模式，可以及时检测主节点的故障并完成故障转移。

# 主从节点信息如何获取

哨兵节点通过配置文件读取所有的主节点，然后通过定时的方式(10s/次) 发送 INFO 命令来获取主节点的相关信息，其中就包括主节点的所有从节点。
# sential 实例之间如何获取彼此的信息

# 探测原理

当哨兵节点获得了主从节点后，就会通过定时的方式发送探测消息，检测节点的状态。如果节点在优先的时间内没有返回响应。该哨兵节点便认为该节点下线，我们把这种下线称为**主观下线**。什么是主观下线？
主观下线只是改哨兵节点觉得目标节点下线了，实际上，**目标节点不一定下线**。如果这个时候进行主节点的重新选举，就会导致同时存在两个主节点，这就是经典的**脑裂**问题。

因此，在哨兵节点认为主观下线后，并不会进行主节点的重新选举。而是会跟其他的节点进行一次沟通，当大多数节点都认为目标节点下线了，此时才认为目标节点真正下线了，我们把这种下线称为**客观下线**。

在 sential 模式中，当哨兵节点认为某个节点客观下线后，会给其他的哨兵实例广播一条消息，询问目标节点是否下线，其他实例收到后，会发送一条响应，哨兵根据该响应判断其他哨兵节点是否也认为目标节点下线了，当认为目标节点下线的哨兵数量大于配置设定的值的时候，就会触发节点的重新选举流程。

# 故障转移 

- leader 哨兵选举
    
故障转移的第一步是选举 leader 哨兵节点，该节点负责后续真正的故障转移流程。那么怎么选举呢？

  - 在一个配置纪元(epoch)内，每一个哨兵节点都有一张投票权。
  - 每个发现主节点下线的实例，都会给其他的哨兵节点发送一条消息，让其给自己投票。
  - 哨兵实例的投票原则为先到先得
  - 最终获得投票梳理大于一半的节点被选举为本次故障转移的负责人
  - 在一次选举中，是有可能没有选举出 leader 实例的，如果发生这种情况，则重试，直到成功选举出 leader 实例

- 故障转移

leader 哨兵会读取下线主节点的所有从节点信息，然后根据一定的规则选举出新的主节点。这里的规则包括：
  - 是否在线
  - 复制偏移量最大(数据最新)
  - 按照 run_id 排序

当选举出新的主节点后，给该主节点发送 `SLAVEOF no one` 命令。并给其他的从节点发送 `SLAVEOF` 命令，使其称为新主节点的从节点。

其他的哨兵实例，通过订阅消息，获取新的主节点信息，并维护在自己的实例中。





# 缺点

哨兵模式的缺点是主节点的数量是固定的，因此会影响服务的**水平扩容**。为此又有了集群模式。