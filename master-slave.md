redis 的主从是如何同步的呢？

我们可以通过执行  `SLAVEOF master_ip master_port` 让某个从服务器从主服务器同步数据。

# 完全重同步

主从同步分为两个步骤：同步 + 命令传播。

同步就是让主从达到一致的状态。后续增量部分通过命令传播来完成同步。

完全重同步通过 `SYNC` 来实现，以下为其执行序列：

- slave 给 master 发送 `SYNC` 命令
- master 执行 BGSAVE 命令，生成 RDB 文件
- 在生产 RDB 文件期间，将所有的新的写操作加入到一个缓冲区
- 当 RDB 文件生成完毕后，发送 RDB 文件给 slave
- 发送缓冲区中的所有的命令给 slave
- 此时，便认为 master 和 slave 达成了一致
- 后续， master 接收到新的写命令后，会传播给从服务器

# 部分重同步

但是，如果 slave 之前已经跟 master 保持一致了，只是临时断开了。当 slave 重新上线后，还需要完全重同步吗？

显然是没有必要的，完全重同步时特别耗费资源的操作，应该尽量避免。

这就涉及到 **复制偏移量** 和 **积压缓冲区** 的概念。

主从服务器都会维护一份复制偏移量，主服务器在传播命令后，就会增加复制偏移量，从服务器在收到命令后，也会增加复制偏移量。当两者不一致的时候，说明主从不一致。

主服务器会在内部维护一个积压缓冲区，在传播命令时，除了发送命令给从服务器，还会将命令存储到积压缓冲区中。当从服务器临时断线重连后，就会发送 `PSYNC offset` 命令给主服务器，主服务器会检测 offset 之后的内容是否还存在在积压缓冲区中，如果存在，则进行部分重同步。否则，需要进行完全重同步。