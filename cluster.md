# 集群都有哪些成员

若干个主节点，每个主节点若干个从节点。

# 数据访问流程

- 如果一次请求涉及多个 key，数据访问流程是什么样的？

    如果涉及多个 key，如果 key 分布在不同的实例上，如果要从不同的实例上汇聚结果，会增加复杂度、影响性能。我们可以通过 `{}` 的方式来指定 hash tag， 所有的 key 都指定相同的 hash tag，即可保证所有的 key 位于一台实例上。
    后续访问流程，跟单 key 访问流程类似。

# 故障检测/转移

- 新实例加入集群流程

我们在某个实例上执行 `CLUSTER MEET` 命令的时候，该实例就会跟新实例握手，握手的过程包括建立 tcp 连接，双方维护对方的信息等。握手成功后，当前实例会给集群广播一条消息，告诉其他实例有新实例加入了并与新实例一一完成握手。至此，集群中每个主节点，都维护了所有其他主节点的信息。

- 故障检测

主节点默认每隔 1s 给所有的主节点发送 `PING` 消息，如果目标节点没有在规定时间内返回响应，则该节点认为目标节点 `疑似下线`， 为什么是疑似下线呢？因为目标节点可能并没有真正下线，没有及时返回响应可能仅仅是临时的网络问题。

当某个节点任务某个节点疑似下线后，便会给集群中其他主节点广播一条消息。每个主节点收到此消息后，便会在疑似下线节点的数据结构中加入一条消息。当某个主节点中针对某个节点记录的疑似下线消息数量大于集群主机点数量一半的时候，该主节点便认为该节点真正下线了，并在集群中给所有节点广播一条某某节点下线的消息

- 故障转移

当下线主节点的从节点，收到自己主节点下线的消息后，便会给所有的主节点广播一条消息，选举自己为新的主节点。每一个主节点在一个新的 epoch(纪元) 都有一次投票权，投票原则是先到先得。当某个从节点的投票数量大于主节点数量一半的时候，该从节点被选举为新的主节点。

然后新的主节点给集群中其他主节点广播一条消息，自己是新的主节点，其他的主节点更新相应的数据结构。

